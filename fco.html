<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Data Fetcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-2xl">
        <h1 class="text-2xl font-bold mb-6 text-center">Company Data Fetcher</h1>
        <div class="flex justify-center space-x-4 mb-4">
            <button id="fetchBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Fetch All</button>
            <button id="pauseBtn" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 hidden">Pause</button>
            <button id="exportJsonBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 hidden">Export JSON</button>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
            <div id="progressBar" class="bg-blue-500 h-4 rounded-full" style="width: 0%"></div>
        </div>
        <div id="log" class="bg-gray-200 p-4 rounded h-64 overflow-y-auto text-sm"></div>
    </div>

    <script>
        const apiBase = 'https://api.tnpnsut.in/companies';
        const token = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY1Zjk1NTUxYzNkNWIzNzMwNzY5YWRiYSIsImlhdCI6MTc1MDg3NTg3NywiZXhwIjoxNzUzNDY3ODc3fQ.RRvoUFo76Q65vECK3P8cIHy7MSgGTd8zkmYYaqE89Dw';
        const years = [2022, 2023, 2024, 2025, 2026, 2027, 2028, 2029, 2030];
        let companies = [];
        let isFetching = false;
        let isPaused = false;
        let currentYearIndex = 0;
        let totalCompanies = 0;

        const fetchBtn = document.getElementById('fetchBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        const logDiv = document.getElementById('log');
        const progressBar = document.getElementById('progressBar');

        function log(message) {
            logDiv.innerHTML += `<p>${new Date().toLocaleTimeString()}: ${message}</p>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateProgress(completed, total) {
            const percentage = (completed / total) * 100;
            progressBar.style.width = `${percentage}%`;
        }

        function flattenObject(obj, prefix = '') {
            return Object.keys(obj).reduce((acc, k) => {
                const pre = prefix.length ? `${prefix}.` : '';
                if (typeof obj[k] === 'object' && obj[k] !== null && !Array.isArray(obj[k])) {
                    Object.assign(acc, flattenObject(obj[k], pre + k));
                } else {
                    acc[pre + k] = obj[k] !== null && obj[k] !== undefined ? obj[k] : '';
                }
                return acc;
            }, {});
        }

        async function fetchCompanies(year) {
            const url = `${apiBase}?year=${year}&_limit=20000`;
            try {
                const response = await fetch(url, {
                    headers: { Authorization: token }
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                return data;
            } catch (error) {
                log(`Error fetching companies for year ${year}: ${error.message}`);
                return [];
            }
        }

        async function fetchCompanyDetails(id) {
            const url = `${apiBase}/${id}`;
            try {
                const response = await fetch(url, {
                    headers: { Authorization: token }
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                return data;
            } catch (error) {
                log(`Error fetching details for company ID ${id}: ${error.message}`);
                return null;
            }
        }

        async function fetchAllCompanies() {
            isFetching = true;
            fetchBtn.classList.add('hidden');
            pauseBtn.classList.remove('hidden');
            exportJsonBtn.classList.add('hidden');
            companies = [];
            totalCompanies = 0;
            currentYearIndex = 0;

            for (let i = currentYearIndex; i < years.length; i++) {
                if (isPaused) {
                    log('Fetching paused');
                    break;
                }
                currentYearIndex = i;
                const year = years[i];
                log(`Fetching companies for year ${year}...`);
                const yearCompanies = await fetchCompanies(year);
                log(`Fetched ${yearCompanies.length} companies for year ${year}`);

                for (const company of yearCompanies) {
                    if (isPaused) {
                        log('Fetching paused');
                        break;
                    }
                    if (!company._id || typeof company._id !== 'string' || company._id.trim() === '') {
                        log(`Skipping company with invalid ID in year ${year}`);
                        continue;
                    }
                    const details = await fetchCompanyDetails(company._id);
                    if (details) {
                        companies.push(details);
                        totalCompanies++;
                        log(`Fetched details for company ${details.Name || 'Unknown'}. Total companies: ${totalCompanies}`);
                    }
                }

                updateProgress(i + 1, years.length);
            }

            if (!isPaused) {
                isFetching = false;
                fetchBtn.classList.remove('hidden');
                pauseBtn.classList.add('hidden');
                exportJsonBtn.classList.remove('hidden');
                log(`Fetching complete. Total companies fetched: ${totalCompanies}`);
                updateProgress(years.length, years.length);
            }
        }

        function exportToJson() {
            const flattenedCompanies = companies.map(company => {
                const flat = flattenObject(company);
                const allFields = {
                    'company_turnover': '', 'placement_ppo': '', 'placement_interviews': '', 'internship_shortlists': '',
                    '_id': '', 'Name': '', 'info': '', 'company_category': '', 'year': '', 'published_at': '',
                    'createdAt': '', 'updatedAt': '', '__v': '',
                    'events': '', 'events.category': '', 'events.degree': '', 'events.status': '', 'events.optional_criteria': '',
                    'events.cgpa_10th': '', 'events.cgpa_12th': '', 'events.graduation_cgpa': '', 'events.is_additional_ques': '',
                    'events.allowed_gender': '', 'events.attachments': '', 'events.attachments._id': '', 'events.attachments.name': '',
                    'events.attachments.hash': '', 'events.attachments.ext': '', 'events.attachments.mime': '',
                    'events.attachments.size': '', 'events.attachments.url': '', 'events.attachments.provider': '',
                    'events.attachments.width': '', 'events.attachments.height': '', 'events.attachments.related': '',
                    'events.attachments.createdAt': '', 'events.attachments.updatedAt': '', 'events.attachments.__v': '',
                    'events.applied': '', 'events.ppo': '', 'events.shortlist': '', 'events._id': '',
                    'events.published_at': '', 'events.additional_ques': '', 'events.additional_ques.type': '',
                    'events.additional_ques.ques': '', 'events.additional_ques.expectedAns': '', 'events.additional_ques.options': '',
                    'events.optional_redirect': '', 'events.additional_info': '', 'events.degrees_allowed': '',
                    'events.stipend_info': '', 'events.duration': '', 'events.apc': '', 'events.campus': '',
                    'events.cap': '', 'events.companyBond': '', 'events.description': '', 'events.lastDate': '',
                    'events.placeOfPosting': '', 'events.backlogs': '', 'events.cgpa': '', 'events.stipend': '',
                    'events.batch': '', 'events.jobtitle': '', 'events.type': '', 'events.branchesAllowed': '',
                    'events.branchesAllowed.branch': '', 'events.branchesAllowed.degree': '', 'events.branchesAllowed._id': '',
                    'events.branchesAllowed.__v': '', 'events.createdAt': '', 'events.updatedAt': '', 'events.__v': '',
                    'events.company': '', 'events.createdPC': ''
                };
                return { ...allFields, ...flat };
            });
            const json = JSON.stringify(flattenedCompanies, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'companies.json';
            a.click();
            URL.revokeObjectURL(url);
            log('Exported to JSON');
        }

        fetchBtn.addEventListener('click', () => {
            if (!isFetching) {
                fetchAllCompanies();
            }
        });

        pauseBtn.addEventListener('click', () => {
            if (isFetching) {
                isPaused = !isPaused;
                pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
                exportJsonBtn.classList.toggle('hidden', !isPaused);
                if (!isPaused) {
                    fetchAllCompanies();
                }
            }
        });

        exportJsonBtn.addEventListener('click', exportToJson);
    </script>
</body>
</html>