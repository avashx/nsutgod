<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSUTGod</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="flex flex-col min-h-screen">
        <header class="bg-blue-600 text-white p-4">
            <h1 class="text-2xl font-bold">NSUTGod</h1>
        </header>

        <nav class="bg-white shadow p-4">
            <ul class="flex space-x-4">
                <li><a href="#" class="text-blue-600 font-semibold">Overview</a></li>
                <li><a href="student-profiles.html" class="text-gray-600 hover:text-blue-600">Student Profile</a></li>
                <li><a href="#" class="text-gray-600 hover:text-blue-600">Analytics</a></li>
                <li><a href="#" class="text-gray-600 hover:text-blue-600">Placement</a></li>
                <li><a href="#" class="text-gray-600 hover:text-blue-600">TnP</a></li>
                <li><a href="#" class="text-gray-600 hover:text-blue-600">Notifications <span class="bg-red-500 text-white rounded-full px-2">2</span></a></li>
            </ul>
        </nav>

        <main class="flex-1 p-4">
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">NSUTGod API Student Fetch</h2>

                <div class="flex space-x-4 mb-4">
                    <button onclick="fetchStudents('all')" class="bg-blue-600 text-white px-4 py-2 rounded">Fetch All</button>
                    <button onclick="fetchStudents(100)" class="bg-gray-200 px-4 py-2 rounded">Fetch 100</button>
                    <button onclick="fetchStudents(150)" class="bg-gray-200 px-4 py-2 rounded">Fetch 150</button>
                    <button onclick="fetchStudents(200)" class="bg-gray-200 px-4 py-2 rounded">Fetch 200</button>
                    <button onclick="fetchStudents(500)" class="bg-gray-200 px-4 py-2 rounded">Fetch 500</button>
                    <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded">Export to CSV</button>
                    <button onclick="exportToJSON()" class="bg-green-600 text-white px-4 py-2 rounded">Export to JSON</button>
                    <button onclick="toggleExpand()" class="bg-gray-200 px-4 py-2 rounded">Expand</button>
                    <button onclick="pauseFetch()" class="bg-red-600 text-white px-4 py-2 rounded">Pause</button>
                </div>

                <div class="flex space-x-4 mb-4">
                    <div>
                        <label>Year:</label>
                        <select id="batchFilter" onchange="fetchStudents('filtered')">
                            <option value="all">All</option>
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                        </select>
                    </div>
                    <div>
                        <label>Type:</label>
                        <input id="typeFilter" type="text" class="border rounded px-2 py-1" placeholder="Enter type">
                    </div>
                    <div>
                        <label>CGPA:</label>
                        <input id="cgpaFilter" type="number" step="0.01" class="border rounded px-2 py-1" placeholder="Enter CGPA">
                    </div>
                    <div>
                        <label>Name:</label>
                        <input id="nameFilter" type="text" class="border rounded px-2 py-1" placeholder="Enter name">
                    </div>
                </div>

                <div class="mb-4">
                    <p>Fetching Students...</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="fetchCount">0 students fetched</p>
                </div>

                <div class="mb-4">
                    <h3 class="text-lg font-semibold">Network Activity Log</h3>
                    <div id="networkLog" class="bg-gray-100 p-2 rounded h-24 overflow-y-auto"></div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 border">Sno. ↕</th>
                                <th class="px-4 py-2 border">Roll Number ↕</th>
                                <th class="px-4 py-2 border">Name ↕</th>
                                <th class="px-4 py-2 border">Branch ↕</th>
                                <th class="px-4 py-2 border">Email ↕</th>
                                <th class="px-4 py-2 border">Gender ↕</th>
                                <th class="px-4 py-2 border">DOB ↕</th>
                                <th class="px-4 py-2 border">Contact Number ↕</th>
                                <th class="px-4 py-2 border">Present Address ↕</th>
                                <th class="px-4 py-2 border">Category ↕</th>
                                <th class="px-4 py-2 border">CGPA ↕</th>
                                <th class="px-4 py-2 border">View</th>
                            </tr>
                        </thead>
                        <tbody id="studentTable"></tbody>
                    </table>
                </div>

                <div class="flex justify-between mt-4">
                    <div>
                        <label>Rows per page:</label>
                        <select id="rowsPerPage" onchange="renderTable()">
                            <option value="300">300</option>
                        </select>
                    </div>
                    <div>
                        <button onclick="prevPage()" class="bg-gray-200 px-4 py-2 rounded">Previous</button>
                        <span id="pageInfo"></span>
                        <button onclick="nextPage()" class="bg-gray-200 px-4 py-2 rounded">Next</button>
                    </div>
                </div>
            </div>

            <div class="text-center">Loading...</div>
        </main>
    </div>

    <script>
        const API_URL = 'https://api.tnpnsut.in/students';
        const BEARER_TOKEN = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY1Zjk1NTUxYzNkNWIzNzMwNzY5YWRiYSIsImlhdCI6MTc1MDg3NTg3NywiZXhwIjoxNzUzNDY3ODc3fQ.RRvoUFo76Q65vECK3P8cIHy7MSgGTd8zkmYYaqE89Dw';
        let students = [];
        let currentPage = 1;
        let isPaused = false;

        async function fetchStudents(limit) {
            if (isPaused) return;
            const batch = document.getElementById('batchFilter').value;
            const type = document.getElementById('typeFilter').value;
            const cgpa = document.getElementById('cgpaFilter').value;
            const name = document.getElementById('nameFilter').value;

            let url = API_URL;
            if (limit !== 'all' && limit !== 'filtered') url += `?_limit=${limit}&_sort=rollNumber`;
            else if (batch !== 'all') url += `?batch=${batch}&_limit=40000&_sort=rollNumber`;

            if (type) url += `&type=${type}`;
            if (cgpa) url += `&cgpa_gte=${cgpa}`;
            if (name) url += `&name_contains=${name}`;

            try {
                document.getElementById('networkLog').innerHTML += `<p>Fetching from ${url}...</p>`;
                const response = await fetch(url, {
                    headers: { 'Authorization': BEARER_TOKEN }
                });
                students = await response.json();
                document.getElementById('fetchCount').textContent = `${students.length} students fetched`;
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('networkLog').innerHTML += `<p>Fetched ${students.length} students</p>`;
                currentPage = 1;
                renderTable();
            } catch (error) {
                document.getElementById('networkLog').innerHTML += `<p>Error: ${error.message}</p>`;
            }
        }

        function renderTable() {
            const rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedStudents = students.slice(start, end);

            let html = '';
            paginatedStudents.forEach((student, index) => {
                html += `
                    <tr>
                        <td class="px-4 py-2 border">${start + index + 1}</td>
                        <td class="px-4 py-2 border">${student.rollNumber || '-'}</td>
                        <td class="px-4 py-2 border">${student.name || '-'}</td>
                        <td class="px-4 py-2 border">${student.branch || '-'}</td>
                        <td class="px-4 py-2 border">${student.email || '-'}</td>
                        <td class="px-4 py-2 border">${student.gender || '-'}</td>
                        <td class="px-4 py-2 border">${student.dob || '-'}</td>
                        <td class="px-4 py-2 border">${student.contact_number || '-'}</td>
                        <td class="px-4 py-2 border">${student.present_address || '-'}</td>
                        <td class="px-4 py-2 border">${student.category || '-'}</td>
                        <td class="px-4 py-2 border">${student.cgpa || '-'}</td>
                        <td class="px-4 py-2 border">
                            <a href="student-profiles.html?id=${student.id}" class="text-blue-600">View Profile</a>
                        </td>
                    </tr>`;
            });
            document.getElementById('studentTable').innerHTML = html;
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${Math.ceil(students.length / rowsPerPage)}`;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            const rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
            if (currentPage < Math.ceil(students.length / rowsPerPage)) {
                currentPage++;
                renderTable();
            }
        }

        function exportToCSV() {
            const headers = ['Sno.', 'Roll Number', 'Name', 'Branch', 'Email', 'Gender', 'DOB', 'Contact Number', 'Present Address', 'Category', 'CGPA'];
            const csv = [
                headers.join(','),
                ...students.map((student, index) => [
                    index + 1,
                    student.rollNumber || '-',
                    student.name || '-',
                    student.branch || '-',
                    student.email || '-',
                    student.gender || '-',
                    student.dob || '-',
                    student.contact_number || '-',
                    student.present_address || '-',
                    student.category || '-',
                    student.cgpa || '-'
                ].join(','))
            ].join('\n');
            downloadFile(csv, 'students.csv', 'text/csv');
        }

        function exportToJSON() {
            const json = JSON.stringify(students, null, 2);
            downloadFile(json, 'students.json', 'application/json');
        }

        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
        }

        function toggleExpand() {
            document.getElementById('studentTable').classList.toggle('max-h-96');
        }

        function pauseFetch() {
            isPaused = !isPaused;
            document.querySelector('button[onclick="pauseFetch()"]').textContent = isPaused ? 'Resume' : 'Pause';
        }

        // Initial fetch
        fetchStudents('all');
    </script>
</body>
</html>